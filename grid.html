<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Grid Planner</title>

<style>
/* ====== YOUR ORIGINAL CSS (UNCHANGED) ====== */
body{
font-family: sans-serif;
max-width:640px;
min-height: 640px;
margin:auto;
background:#ffffff;
display:flex;
justify-content:center;
align-items: center; 
padding: 15px 20px 0px;
border-radius:24px;
border: 3px solid #e2e2e2;
}
.widgetWrap{
width:640px;height:640px;background:#fff;display:flex;flex-direction:column;border-radius:24px;
}
.container{flex:1;position:relative;overflow:hidden;display:flex;flex-direction:column;}
.container.popup-open .gridWrap{opacity:.4}
.header{display:grid;grid-template-columns:auto 1fr auto;align-items:center;padding:14px 18px;}
.refreshBtn{background:black;color:white;border:none;padding:6px;border-radius:10px;font-weight:600;cursor:pointer;font-size:14px;display:flex;align-items:center;gap:6px;}
.refreshIcon.spin{animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.title{text-align:right;font-weight:700;font-size:16px}
.tabs{display:grid;grid-template-columns:repeat(4,1fr);padding:10px 0 8px;position:relative}
.slidingUnderline{position:absolute;bottom:0;height:2px;width:18px;background:black;border-radius:2px;transition:.35s}
.tabItem{display:flex;flex-direction:column;align-items:center;cursor:pointer}
.tabItem img{width:22px;height:22px;opacity:.45}
.tabItem.active img{opacity:1}
.gridWrap{flex:1;overflow-y:auto}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:3px;padding:4px}
.card{aspect-ratio:4/5;background:#efefef;position:relative;overflow:hidden}
.card img,.card video{width:100%;height:100%;object-fit:cover}
.cardInfo{position:absolute;bottom:0;width:100%;background:linear-gradient(to top,rgba(0,0,0,.7),transparent);color:#fff;padding:6px;transform:translateY(100%);transition:.25s}
.card:hover .cardInfo{transform:translateY(0)}
.cardTitle{font-size:13px;line-height:1}
.cardDate{font-size:10px;margin-top:2px}
.badge{position:absolute;top:6%;right:6%;width:16%;opacity:.8}
.noContent{font-size:11px;color:#aaa}
.viewer{position:absolute;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:.25s}
.viewer.show{opacity:1;pointer-events:auto}
.viewer.hidden{display:none}
.viewerInner{width:min(360px,85%);position:relative}
.viewerCard{background:#fff;border-radius:20px;overflow:hidden}
.viewerImage{aspect-ratio:4/5}
.viewerImage img,.viewerImage video{width:100%;height:100%;object-fit:cover}
.viewerFooter{padding:14px}
.viewerClose{position:absolute;top:-14px;right:-14px;background:#000;color:#fff;border:none;border-radius:50%;width:32px;height:32px}
.nav{position:absolute;top:50%;transform:translateY(-50%);background:#000;color:#fff;border:none;border-radius:50%;width:36px;height:36px}
.nav.prev{left:-14px}
.nav.next{right:-14px}
.footer{text-align:center;font-size:13px;color:#777;padding:8px}
</style>
</head>

<body>
<div class="widgetWrap">
<div class="container">

<div class="header">
<button class="refreshBtn"><span class="refreshIcon">⟳</span>Refresh</button>
<div class="title">Grid Planner</div>
</div>

<div class="contentArea">
<div class="tabs">
  <div class="tabItem active" data-type="post" onclick="setFilter('Post',this)"><img src="/icons/post-dark.png"></div>
  <div class="tabItem" data-type="reel" onclick="setFilter('Reels',this)"><img src="/icons/reel-light.png"></div>
  <div class="tabItem" data-type="story" onclick="setFilter('Story',this)"><img src="/icons/story-light.png"></div>
  <div class="tabItem" data-type="tiktok" onclick="setFilter('Tiktok',this)"><img src="/icons/tiktok-light.png"></div>
  <div class="slidingUnderline" id="slidingUnderline"></div>
</div>

<div class="gridWrap"><div id="grid" class="grid"></div></div>
</div>

<div id="viewer" class="viewer hidden">
  <div class="viewerInner">
    <button class="viewerClose" onclick="closeViewer()">✕</button>
    <button class="nav prev" onclick="prevImage()">‹</button>
    <button class="nav next" onclick="nextImage()">›</button>
    <div class="viewerCard">
      <div class="viewerImage" id="viewerMedia"></div>
      <div class="viewerFooter">
        <div id="viewerTitle"></div>
        <div id="viewerDate"></div>
      </div>
    </div>
  </div>
</div>

</div>
<div class="footer">Alif Designs</div>

<script>
/* ====== HELPERS ====== */
function formatDateShort(d){if(!d)return"";const x=new Date(d);return isNaN(x)?"":x.toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"2-digit"})}

function normalizeMedia(post){
  if(post.attachment){
    const arr=Array.isArray(post.attachment)?post.attachment:[post.attachment];
    return {type:"image",src:arr[0],all:arr}
  }
  if(post.video){
    const yt=post.video.match(/(?:shorts\/|v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
    if(yt)return{type:"youtube",src:`https://img.youtube.com/vi/${yt[1]}/hqdefault.jpg`,all:[`https://img.youtube.com/vi/${yt[1]}/hqdefault.jpg`]}
    if(post.video.match(/\.(mp4|webm|ogg)$/i))return{type:"video",src:post.video,all:[post.video]}
    return{type:"link",src:"/icons/video.png"}
  }
  return null
}

/* ====== STATE ====== */
let ALL_POSTS=[],FILTER="Post",currentMedia=[],currentSlide=0;

/* ====== TABS ====== */
function setFilter(type,el){
FILTER=type;
document.querySelectorAll(".tabItem").forEach(t=>t.classList.remove("active"));
el.classList.add("active");
renderGrid();
}

/* ====== FETCH ====== */
async function loadPosts(){
try{
const r=await fetch("/api/get-posts");
ALL_POSTS=await r.json();
}catch{ALL_POSTS=[]}
renderGrid();
}

/* ====== GRID ====== */
function renderGrid(){
const grid=document.getElementById("grid");
grid.innerHTML="";
const filtered=ALL_POSTS.filter(p=>!p.type?.length||p.type.includes(FILTER));
for(let i=0;i<Math.max(filtered.length,60);i++){
const card=document.createElement("div");card.className="card";
const post=filtered[i];
if(post){
const media=normalizeMedia(post);
if(media){
const img=document.createElement("img");img.src=media.src;card.appendChild(img);
if(media.type==="video"){
const vid=document.createElement("video");
Object.assign(vid,{src:media.src,muted:true,loop:true,playsInline:true});
vid.style.position="absolute";vid.style.inset=0;vid.style.opacity=0;vid.style.transition=".2s";
card.appendChild(vid);
card.onmouseenter=()=>{vid.play();vid.style.opacity=1};
card.onmouseleave=()=>{vid.pause();vid.currentTime=0;vid.style.opacity=0};
}
card.onclick=()=>openViewer(post);
}
if(post.name||post.publishDate){
const info=document.createElement("div");info.className="cardInfo";
if(post.name){const t=document.createElement("div");t.className="cardTitle";t.textContent=post.name;info.appendChild(t)}
if(post.publishDate){const d=document.createElement("div");d.className="cardDate";d.textContent=formatDateShort(post.publishDate);info.appendChild(d)}
card.appendChild(info);
}
}else{
const n=document.createElement("div");n.className="noContent";n.textContent="NO CONTENT";card.appendChild(n)
}
grid.appendChild(card)
}
}

/* ====== VIEWER ====== */
function openViewer(post){
const media=normalizeMedia(post);
currentMedia=media?.all||[];
currentSlide=0;
updateViewer();
document.getElementById("viewerTitle").textContent=post.name||"";
document.getElementById("viewerDate").textContent=formatDateShort(post.publishDate);
document.getElementById("viewer").classList.remove("hidden");
requestAnimationFrame(()=>document.getElementById("viewer").classList.add("show"));
}

function updateViewer(){
const c=document.getElementById("viewerMedia");c.innerHTML="";
if(!currentMedia.length)return;
const src=currentMedia[currentSlide];
if(src.match(/\.(mp4|webm|ogg)$/)){
const v=document.createElement("video");v.src=src;v.controls=true;v.autoplay=true;c.appendChild(v)
}else{
const i=document.createElement("img");i.src=src;c.appendChild(i)
}
}

function closeViewer(){
const v=document.getElementById("viewer");
v.classList.remove("show");
setTimeout(()=>v.classList.add("hidden"),200)
}
function prevImage(){currentSlide=(currentSlide-1+currentMedia.length)%currentMedia.length;updateViewer()}
function nextImage(){currentSlide=(currentSlide+1)%currentMedia.length;updateViewer()}

/* ====== INIT ====== */
loadPosts();
</script>
</body>
</html>
