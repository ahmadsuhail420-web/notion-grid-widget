<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">

<style>
/* ---------- BASE ---------- */
body {
  font-family: sans-serif;
  max-width: 640px;
  min-height: 640px;
  margin: auto;
  background: #ffffff;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 15px 20px 0;
  border-radius: 24px;
  border: 3px solid #e2e2e2;
}

.widgetWrap {
  width: 100%;
  max-width: 640px;
  height: 640px;
  background: #ffffff;
  display: flex;
  flex-direction: column;
  border-radius: 24px;
}

.container {
  flex: 1;
  display: flex;
  flex-direction: column;
  position: relative;
}

.container[data-loading="true"] .profile,
.container[data-loading="true"] .highlights,
.container[data-loading="true"] .contentArea {
  display: none;
}

/* ---------- HEADER ---------- */
.header {
  display: flex;
  justify-content: space-between;
  padding: 12px 16px;
}

.refreshBtn {
  background: transparent;
  border: none;
  cursor: pointer;
}

.refreshIcon.spin {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* ---------- PROFILE ---------- */
.profile {
  padding: 16px;
  display: flex;
  justify-content: center;
}

.profileRow {
  display: flex;
  max-width: 520px;
  gap: 20px;
}

.profilePic {
  width: 72px;
  height: 72px;
  border-radius: 50%;
  overflow: hidden;
  background: #eee;
}

.profilePic img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.profileStats {
  display: grid;
  grid-template-columns: repeat(3, auto);
  gap: 28px;
  margin-top: 8px;
}

/* ---------- HIGHLIGHTS ---------- */
.highlights {
  padding: 8px 16px 0;
}

.highlightsRow {
  display: flex;
  gap: 12px;
  overflow-x: auto;
}

.highlightItem {
  width: 62px;
  height: 62px;
  border-radius: 50%;
  border: 2px solid #ddd;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ---------- TABS ---------- */
.tabs {
  display: grid;
  grid-template-columns: repeat(4,1fr);
  padding: 10px 0;
  position: relative;
}

.tabItem {
  display: flex;
  justify-content: center;
  cursor: pointer;
}

.slidingUnderline {
  position: absolute;
  bottom: 0;
  width: 18px;
  height: 2px;
  background: black;
  transition: transform .3s ease;
}

/* ---------- GRID ---------- */
.gridWrap {
  flex: 1;
  overflow-y: auto;
}

.grid {
  display: grid;
  grid-template-columns: repeat(3,1fr);
  gap: 3px;
  padding: 4px;
}

.card {
  aspect-ratio: 4/5;
  background: #efefef;
  position: relative;
}

.card img,
.card video {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.badge {
  position: absolute;
  top: 4%;
  right: 6%;
  width: 16%;
}

/* ---------- VIEWER ---------- */
.viewer {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,.35);
  display: none;
}

.viewer.show { display: flex; }

/* ---------- FOOTER ---------- */
.footer {
  text-align: center;
  padding: 8px;
  font-size: 13px;
  color: #777;
}

/* ---------- SKELETON ---------- */
#skeleton {
  padding: 16px;
}

.sk-avatar {
  width: 72px;
  height: 72px;
  border-radius: 50%;
  background: #eee;
}

.sk-line {
  height: 12px;
  background: #eee;
  border-radius: 6px;
  margin: 8px 0;
}

.sk-grid {
  display: grid;
  grid-template-columns: repeat(3,1fr);
  gap: 3px;
}

.sk-grid div {
  aspect-ratio: 4/5;
  background: #eee;
}

#skeleton * {
  animation: shimmer 1.2s infinite linear;
  background: linear-gradient(90deg,#eee,#f5f5f5,#eee);
  background-size: 400% 100%;
}

@keyframes shimmer {
  0% { background-position: 100% 0; }
  100% { background-position: -100% 0; }
}
</style>
</head>

<body>
<div class="widgetWrap">
<div class="container" data-loading="true">

<!-- HEADER -->
<div class="header">
<button class="refreshBtn"><span class="refreshIcon">⟳</span></button>
</div>

<!-- SKELETON -->
<div id="skeleton">
  <div class="sk-avatar"></div>
  <div class="sk-line"></div>
  <div class="sk-line"></div>
  <div class="sk-grid">
    <div></div><div></div><div></div>
    <div></div><div></div><div></div>
  </div>
</div>

<!-- PROFILE -->
<div class="profile">
  <div class="profileRow">
    <div class="profilePic"><img id="profileImage"></div>
    <div>
      <div id="profileName"></div>
      <div class="profileStats">
        <div><strong id="statPosts">0</strong><br>Posts</div>
        <div><strong id="statScheduled">0</strong><br>Scheduled</div>
        <div><strong id="statPublished">0</strong><br>Published</div>
      </div>
    </div>
  </div>
</div>

<!-- HIGHLIGHTS -->
<div class="highlights">
  <div id="highlights" class="highlightsRow"></div>
</div>

<!-- CONTENT -->
<div class="contentArea">
  <div class="tabs">
    <div class="tabItem active" onclick="setFilter('Post',this)">▦</div>
    <div class="tabItem" onclick="setFilter('Reels',this)">▶</div>
    <div class="tabItem" onclick="setFilter('Story',this)">◯</div>
    <div class="tabItem" onclick="setFilter('Tiktok',this)">♪</div>
    <div id="slidingUnderline" class="slidingUnderline"></div>
  </div>

  <div class="gridWrap">
    <div id="grid" class="grid"></div>
  </div>
</div>

</div>
<div class="footer">Alif Designs</div>
</div>

<script>
let ALL_POSTS=[], FILTER="Post";

/* ---------- LOAD ---------- */
async function loadPosts(btn){
  const icon = btn?.querySelector(".refreshIcon");
  if(icon) icon.classList.add("spin");

  document.querySelector(".container").setAttribute("data-loading","true");
  document.getElementById("skeleton").style.display="block";

  const slug = new URLSearchParams(location.search).get("slug");
  const res = await fetch(`/api/get-posts?slug=${slug}`);
  const data = await res.json();

  ALL_POSTS = data.posts || [];

  document.getElementById("profileName").innerText = data.profile?.name || "Grid Planner";
  document.getElementById("profileImage").src = data.profile?.picture || "";

  renderHighlights();
  renderGrid();
  updateStats();

  document.getElementById("skeleton").style.display="none";
  document.querySelector(".container").removeAttribute("data-loading");

  if(icon) icon.classList.remove("spin");
}

/* ---------- GRID ---------- */
function renderGrid(){
  const grid=document.getElementById("grid");
  grid.innerHTML="";
  getVisiblePosts().forEach(p=>{
    const c=document.createElement("div");
    c.className="card";
    const src=p.attachment?.[0]||p.thumbnail||p.video;
    if(src){
      const el=src.match(/mp4|webm/)
        ? Object.assign(document.createElement("video"),{src,muted:true})
        : Object.assign(document.createElement("img"),{src});
      c.appendChild(el);
    }
    grid.appendChild(c);
  });
}

function renderHighlights(){
  const row=document.getElementById("highlights");
  row.innerHTML="";
  const items=ALL_POSTS.filter(p=>p.highlight && p.attachment?.length);
  if(!items.length){
    row.innerHTML='<div class="highlightItem">+</div>';
    return;
  }
  items.forEach(p=>{
    const d=document.createElement("div");
    d.className="highlightItem";
    d.innerHTML=`<img src="${p.attachment[0]}">`;
    row.appendChild(d);
  });
}

function getVisiblePosts(){
  return ALL_POSTS.filter(p=>{
    if(p.hide) return false;
    if(!p.attachment?.length && !p.thumbnail && !p.video) return false;
    return !p.type?.length || p.type.includes(FILTER);
  });
}

function updateStats(){
  const v=getVisiblePosts();
  const today=new Date().toISOString().split("T")[0];
  document.getElementById("statPosts").innerText=v.length;
  document.getElementById("statScheduled").innerText=v.filter(p=>p.publishDate>today).length;
  document.getElementById("statPublished").innerText=v.filter(p=>p.publishDate<=today).length;
}

function setFilter(t,el){
  FILTER=t;
  document.querySelectorAll(".tabItem").forEach(x=>x.classList.remove("active"));
  el.classList.add("active");
  renderGrid();
}

document.querySelector(".refreshBtn").onclick=function(){loadPosts(this)};
window.addEventListener("load",()=>loadPosts());
</script>
</body>
</html>