<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />

  <style>
    
    /* ---------- THEME VARIABLES ---------- */
    
:root {
  /* light mode */
  --bg-main: #ffffff;
  --bg-card: #ffffff;
  --bg-muted: #f5f5f5;

  --text-main: #111111;
  --text-muted: #777777;

  --border-color: #e2e2e2;
  --shadow: 0 10px 30px rgba(0,0,0,0.12);

  --toggle-off: #ddd;
  --toggle-on: #000;
}

    /* ---------- DARK MODE ---------- */
    
body[data-theme="dark"] {
  --bg-main: #0f0f0f;
  --bg-card: #1a1a1a;
  --bg-muted: #222222;

  --text-main: #f2f2f2;
  --text-muted: #9a9a9a;

  --border-color: rgba(255, 255, 255, .35);
  --shadow: 0 10px 30px rgba(0,0,0,0.25);

  --toggle-off: #555;
  --toggle-on: #fff;
}

    /* ---------- BASE ---------- */
    
    body {
      font-family:
    -apple-system,
    BlinkMacSystemFont,
    "SF Pro Text",
    "SF Pro Display",
    "Segoe UI",
    Roboto,
    Helvetica,
    Arial,
    sans-serif;
      max-width: 500px;
      max-height: 700px;
      margin: auto;
      background: var(--bg-main);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 15px 20px 0;
      border-radius: 24px;
      border: 3px solid var(--border-color);
      transition: 
    background-color 0.25s ease,
    color 0.25s ease,
    border-color 0.25s ease;
}

    .widgetWrap {
      width: 100%;
      max-width: 500px;
      height: 700px;
      background: var(--bg-main);
      position: relative;
      display: flex;
      flex-direction: column;
      border-radius: 24px;
      transition: 
    background-color 0.25s ease,
    color 0.25s ease,
    border-color 0.25s ease;
    }

    /* ✅ HIDE CONTENT UNTIL DATA LOADS (CSS MUST BE HERE, NOT IN <script>) */
    .container[data-loading="true"] #profileHeader,
    .container[data-loading="true"] #highlightsWrap,
    .container[data-loading="true"] .gridWrap {
      visibility: hidden;
    }

    .topBar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      position: relative;
    }
    
    .hidden-section {
  display: none !important;
}

    /* PROFILE */
    .profile {
      padding: 20px 16px;
      display: flex;
      justify-content: center;
      flex: 0 1 auto;
    }

    .profileRow {
      display: flex;
      max-width: 520px;
      align-items: center;
      gap: clamp(10px, 5vw, 24px);
    }

    .profilePic {
     width: clamp(44px, 20vw, 108px);
      aspect-ratio: 1 / 1;
      border-radius: 50%;
      overflow: hidden;
      background: #eee;
      flex-shrink: 0;
    }

    .profilePic img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profileRight {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding: 2px 6px;
    }

    .profileTitle {
     font-size: clamp(12px, 4.5vw, 20px);
      font-weight: 700;
      line-height: 1.2;
      color: var(--text-main);
    }
    
    .profileNote {
  text-align: center;
  font-size: clamp(10px, 3.5vw, 24px);
  color: var(--text-muted);
  padding: 6px 16px 10px;
}

    .profileStats {
      display: grid;
      grid-template-columns: repeat(3, auto);
      column-gap: clamp(14px, 7vw, 36px);
      margin-top: 10px;
    }

    .stat {
      text-align: center;
    }

    .stat strong {
      font-size: clamp(11px, 4vw, 18px);
      font-weight: 700;
      color: var(--text-main);
      display: block;
    }

    .stat span {
      font-size: clamp(9px, 3.2vw, 13px);
      color: var(--text-muted);
    }

    /* ---------- CONTAINER ---------- */
    .container {
      flex: 1;
      min-height: 0;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
    }

    .container.popup-open .gridWrap {
      opacity: 0.4;
    }

    .menuBtn {
      background: transparent;
      border: none;
      font-size: 22px;
      color: var(--text-main);
      cursor: pointer;
      transition: filter 0.25s ease, opacity 0.25s ease, color 0.25s ease;
    }

    .menu {
      position: absolute;
      top: 44px;
      right: 12px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 10px 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 20;
      transition: 
    background-color 0.25s ease,
    color 0.25s ease,
    border-color 0.25s ease;
    }

    .menu.hidden {
      display: none;
    }

    .menuItem {
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }
    
    /* ---------- THEME SEGMENT (PILL) ---------- */

.themeTitle {
  font-size: 12px;
  font-weight: 600;
  opacity: 0.6;
}

.themeSegment {
  position: relative;
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0;
  padding: 4px;
  background: var(--bg-muted);
  border-radius: 999px;
  border: 1px solid var(--border-color);
  width: 180px;               /* compact width */
}

.themeIndicator {
  position: absolute;
  top: 4px;
  left: 4px;
  height: 26px;
  width: calc((100% - 8px) / 3);
  border-radius: 999px;
  background: #000;
  transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1),
              background-color 0.25s ease;
  z-index: 0;
}

/* buttons */
.themeSegment button {
  height: 26px;
  border: none;
  background: transparent;
  font-size: 11px;
  font-weight: 600;
  color: var(--text-muted);
  cursor: pointer;
  z-index: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
}

/* active text */
.themeSegment button.active {
  color: #fff;
}

/* dark mode pill colors */
body[data-theme="dark"] .themeIndicator {
  background: #f5f5f7;
}

body[data-theme="dark"] .themeSegment button.active {
  color: #111;
}
    
.toggleItem input {
  position: absolute;
  opacity: 0;
  pointer-events: none;
}
    .toggleItem {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  cursor: pointer;
}

.menuLabel {
  font-size: 13px;
}

/* switch background */
.toggle {
  width: 34px;
  height: 18px;
  background: var(--toggle-off);
  border-radius: 999px;
  position: relative;
  transition: background 0.25s ease;
}

.toggle::before {
  content: "";
  position: absolute;
  top: 1.5px;
  left: 1.5px;
  width: 15px;
  height: 15px;
  background: var(--bg-card);
  border-radius: 50%;
  box-shadow: 0 2px 6px rgba(0,0,0,0.35);
  transition:
    transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1),
    background 0.25s ease;
}

.toggleItem input:checked + .toggle {
  background: var(--toggle-on);
}

.toggleItem input:checked + .toggle::before {
  transform: translateX(16px);
}


.menuLabel {
  font-size: 13px;
  color: var(--text-main);
}

.toggleItem:active .toggle::before {
  transform: scale(0.92);
}

    /* ---------- HEADER ---------- */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }
   
    .headerTitle {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  font-size: 14px;
  font-weight: 600;
  color: var(--text-main);
  pointer-events: none; /* prevents blocking clicks */
}

    .refreshBtn {
      background: transparent;
      color: var(--text-main);
      border: none;
      padding: 1px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .refreshIcon {
      font-size: 18px;
      color: var(--text-main);
      transition: filter 0.25s ease, opacity 0.25s ease, color 0.25s ease;
    }

    .refreshIcon.spin {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
/* ---------- HIGHLIGHTS ---------- */

    .highlights {
  display: flex;
  justify-content: center;
  flex: 0 1 auto;
}

.highlightsRow {
  width: 100%;
  max-width: 520px;
  display: flex;
  gap: 12px;
  padding-left: 12px;
  overflow-x: auto;          /* ✅ allow scroll */
  flex-wrap: nowrap;         /* ✅ prevent wrapping */
}
    .highlightsRow::-webkit-scrollbar {
      display: none;
    }

.highlightItem {
  width: clamp(36px, 16vw, 76px);
  aspect-ratio: 1 / 1;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  transition: 
    background-color 0.25s ease,
    color 0.25s ease,
    border-color 0.25s ease;
  flex-shrink: 0;            /* ✅ KEEP SIZE */
}

 .highlightItem img {
  width: 92%;
  height: 92%;
  border-radius: 50%;
  object-fit: cover;
}
/* empty placeholder */
.highlightPlaceholder {
  background: var(--bg-muted);
  border-color: rgba(0, 0, 0, 0.08);
}

body[data-theme="dark"] .highlightPlaceholder {
  background: rgba(255,255,255,0.06);
  border-color: rgba(255,255,255,0.15);
}
    #highlightsWrap {
  margin-bottom: 12px; /* adjust: 8px / 12px / 16px */
}
#highlightsWrap:not(.hidden-section) {
  margin-bottom: 12px;
}
    /* ---------- TABS ---------- */
    .tabs {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      align-items: center;
      padding: 10px 0 8px;
      position: relative;
    }

    .tabItem {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .tabItem img {
      width: 22px;
      height: 22px;
      opacity: 0.45;
      transition: transform 0.25s ease, opacity 0.25s ease;
    }

    .tabItem.active img {
      opacity: 1;
      transform: translateY(-2px) scale(1.05);
    }

    .slidingUnderline {
      position: absolute;
      bottom: 0;
      height: 2px;
      width: 18px;
  background: var(--text-main);
      border-radius: 2px;
      transform: translateX(0);
      transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      transition: filter 0.25s ease, opacity 0.25s ease, color 0.25s ease;
    }

    /* ---------- GRID ---------- */
    .gridWrap {
      flex: 1;
      overflow-y: auto;
      scrollbar-width: none;
      transition: opacity 0.2s ease;
    }

    .gridWrap::-webkit-scrollbar {
      display: none;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 3px;
      padding: 4px;
    }

    .card {
      aspect-ratio: 5 / 7;
      background: var(--bg-muted);
      overflow: hidden;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: 
    background-color 0.25s ease,
    color 0.25s ease,
    border-color 0.25s ease;
    }

    .card img,
    .card video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .card img {
      z-index: 1;
      pointer-events: none;
    }

    .card video {
      opacity: 0;
      transition: opacity 0.2s ease;
      pointer-events: none;
    }

    .card:hover video {
      opacity: 1;
    }

    .card .badge {
      position: absolute;
      top: 4%;
      right: 6%;
      width: 16%;
      height: 16%;
      object-fit: contain;
      z-index: 5;
      opacity: 0.8;
      pointer-events: none;
    }

    /* ---------- VIEWER ---------- */
    .viewer {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
    }

    .viewer.show {
      opacity: 1;
      pointer-events: auto;
    }

    .viewer.hidden {
      display: none;
    }

    .viewerInner {
      width: min(360px, 85%);
      position: relative;
      transform: scale(0.96);
      transition: transform 0.25s ease;
    }

    .viewer.show .viewerInner {
      transform: scale(1);
    }

    .viewerCard {
      background: var(--bg-card);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 12px 40px rgba(0,0,0,0.25);
    }

    .viewerImage {
      aspect-ratio: 5 / 7;
      overflow: hidden;
    }

    .viewerImage img,
    .viewerImage video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .viewerFooter {
      padding: 14px 16px;
      border-top: 1px solid var(--border-color);
  color: var(--text-main);
    }

    .viewerClose,
    .nav {
      position: absolute;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(0,0,0,0.65);
      color: #fff;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.35);
    }

    .viewerClose {
      top: -14px;
      right: -14px;
      font-size: 16px;
    }
    body[data-theme="dark"] .card video {
  opacity: 0.85;
}
/* ---------- DARK MODE TAB ICONS ---------- */
body[data-theme="dark"] .tabItem img {
  filter: invert(1) brightness(1.1);
  opacity: 0.75;
}
body[data-theme="dark"] .tabItem.active img {
  opacity: 1;
}

    .nav {
      top: 50%;
      transform: translateY(-50%);
      font-size: 20px;
    }

    .nav.prev { left: -14px; }
    .nav.next { right: -14px; }

    .footer {
      text-align: center;
      padding: 8px 0;
      font-size: 13px;
      color: var(--text-muted);
    }
    
    /* ---------- PROFILE AVATAR OFF MODE ---------- */

.profile.no-avatar .profilePic {
  display: none;
}

.profile.no-avatar .profileRow {
  justify-content: center;
}

.profile.no-avatar .profileRight {
  align-items: center;
  text-align: center;
}

/* slightly increase size when avatar is hidden */
.profile.no-avatar .profileTitle {
  font-size: clamp(14px, 5vw, 24px);
}

.profile.no-avatar .profileStats {
  column-gap: clamp(18px, 8vw, 48px);
}

.profile.no-avatar .stat strong {
  font-size: clamp(13px, 4.5vw, 20px);
}

    /* ---------- SKELETON ---------- */

#skeleton {
  padding: 16px;
}

.sk-profile {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 20px;
}

.sk-avatar {
  width: 72px;
  height: 72px;
  border-radius: 50%;
  background: var(--bg-muted);
}

.sk-lines {
  flex: 1;
}

.sk-line {
  height: 12px;
  background: var(--bg-muted);
  border-radius: 6px;
  margin-bottom: 8px;
}

.sk-line.short {
  width: 40%;
}

.sk-highlights {
  display: flex;
  gap: 12px;
  margin: 16px 0;
}

.sk-circle {
  width: 62px;
  height: 62px;
  border-radius: 50%;
  background: var(--bg-muted);
}

.sk-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 3px;
}

.sk-grid div {
  aspect-ratio: 4 / 5;
  background: var(--bg-muted);
  border-radius: 2px;
}

/* shimmer */
#skeleton * {
  animation: shimmer 1.2s infinite linear;
  background: linear-gradient(
    90deg,
    #eee 25%,
    #f5f5f5 37%,
    #eee 63%
  );
  background-size: 400% 100%;
}

@keyframes shimmer {
  0% { background-position: 100% 0; }
  100% { background-position: -100% 0; }
}

  </style>
</head>
<body>
  <div class="widgetWrap">
    <div class="container" data-loading="true">

      <div class="header">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <button class="refreshBtn">
          <span class="material-icons refreshIcon">refresh</span>
        </button>
        
        <div class="headerTitle">Grid Widget</div>

       <button class="menuBtn" onclick="event.stopPropagation(); toggleMenu()">⋯</button>

        <div id="menu" class="menu hidden" onclick="event.stopPropagation()">
  <label class="menuItem toggleItem">
    <span class="menuLabel">Header</span>
    <input type="checkbox" checked onchange="toggleSection('header', this)">
    <span class="toggle"></span>
  </label>

  <label class="menuItem toggleItem">
    <span class="menuLabel">Highlights</span>
    <input type="checkbox" checked onchange="toggleSection('highlights', this)">
    <span class="toggle"></span>
  </label>
  
  <label class="menuItem toggleItem">
  <span class="menuLabel">Profile</span>
  <input type="checkbox" checked onchange="toggleAvatar(this)">
  <span class="toggle"></span>
</label>

<label class="menuItem toggleItem">
  <span class="menuLabel">Note</span>
  <input type="checkbox" checked onchange="toggleProfileNote(this)">
  <span class="toggle"></span>
</label>
          
       <div class="menuSection">
  <div class="menuLabel themeTitle">Theme</div>

  <div class="themeSegment">
    <div class="themeIndicator"></div>

    <button data-theme-btn="light" onclick="setTheme('light')">
      <span>Light</span>
    </button>

    <button data-theme-btn="dark" onclick="setTheme('dark')">
      <span>Dark</span>
    </button>

    <button data-theme-btn="default" onclick="setTheme('default')">
      <span>Auto</span>
    </button>
  </div>
</div>
</div>
      </div>
      
<!-- SKELETON -->
      <div id="skeleton">

  <div class="sk-profile">
    <div class="sk-avatar"></div>
    <div class="sk-lines">
      <div class="sk-line short"></div>
      <div class="sk-line"></div>
    </div>
  </div>

  <div class="sk-highlights">
    <div class="sk-circle"></div>
    <div class="sk-circle"></div>
    <div class="sk-circle"></div>
    <div class="sk-circle"></div>
  </div>

  <div class="sk-grid">
    <div></div><div></div><div></div>
    <div></div><div></div><div></div>
  </div>

</div>
      <div id="profileHeader" class="profile">
        <div class="profileRow">
          <div class="profilePic">
            <img id="profileImage" src="/icons/profile-placeholder.png" />
          </div>

          <div class="profileRight">
            <div id="profileName" class="profileTitle">Grid Planner</div>

            <div class="profileStats">
              <div class="stat">
                <strong id="statPosts">0</strong>
                <span>Posts</span>
              </div>
              <div class="stat">
                <strong id="statScheduled">0</strong>
                <span>Scheduled</span>
              </div>
              <div class="stat">
                <strong id="statPublished">0</strong>
                <span>Published</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div id="profileNote" class="profileNote">
  Content Planner
</div>

      <!-- HIGHLIGHTS -->
      <div id="highlightsWrap" class="highlights">
        <div id="highlights" class="highlightsRow"></div>
      </div>

      <!-- TABS -->
      <div class="contentArea">
        <div class="tabs">
          <div class="tabItem active" data-type="post" onclick="setFilter('Post', this)">
            <img src="/icons/post-dark.png">
          </div>

          <div class="tabItem" data-type="reel" onclick="setFilter('Reels', this)">
            <img src="/icons/reel-light.png">
          </div>

          <div class="tabItem" data-type="story" onclick="setFilter('Story', this)">
            <img src="/icons/story-light.png">
          </div>

          <div class="tabItem" data-type="tiktok" onclick="setFilter('Tiktok', this)">
            <img src="/icons/tiktok-light.png">
          </div>

          <div class="slidingUnderline" id="slidingUnderline"></div>
        </div>

        <div class="gridWrap">
          <div id="grid" class="grid"></div>
        </div>
      </div>

      <!-- MEDIA VIEWER -->
      <div id="viewer" class="viewer hidden" onclick="closeViewer()">
  <div class="viewerInner" onclick="event.stopPropagation()">
          <button class="viewerClose" onclick="closeViewer()">✕</button>
          <button class="nav prev" onclick="prevImage()">‹</button>
          <button class="nav next" onclick="nextImage()">›</button>

          <div class="viewerCard">
            <div class="viewerImage" id="viewerMedia"></div>

            <div class="viewerFooter">
              <div id="viewerTitle"></div>
              <div id="viewerDate"></div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <div class="footer">Alif Designs</div>
  </div>

<script>
function getSlug() {
  const params = new URLSearchParams(window.location.search);
  return params.get("slug");
}

let ALL_POSTS = [];
let FILTER = "Post";
let currentSlide = 0;
let currentMedia = [];

/* -------------------- HELPERS -------------------- */

function hasMedia(post) {
  return (
    (Array.isArray(post.attachment) && post.attachment.length > 0) ||
    post.thumbnail ||
    post.video
  );
}

function getVisibleGridPosts() {
  return ALL_POSTS
    .filter(post => {
      if (post.hide) return false;
      if (!hasMedia(post)) return false;

      if (!Array.isArray(post.type) || post.type.length === 0) return true;
      return post.type.includes(FILTER);
    })
    .sort((a, b) => (b.pinned === true) - (a.pinned === true));
}

function computeStatsFromGrid(posts) {
  const today = new Date().toISOString().split("T")[0];
  return {
    total: posts.length,
    scheduled: posts.filter(p => p.publishDate && p.publishDate > today).length,
    published: posts.filter(p => p.publishDate && p.publishDate <= today).length
  };
}

function extractProfileFromPosts(posts) {
  const rowWithName = posts.find(p => p.profileName);
  const rowWithPic = posts.find(p => p.profilePicture);
  return {
    name: rowWithName?.profileName || "Grid Planner",
    picture: rowWithPic?.profilePicture || "/icons/profile-placeholder.png"
  };
}

/* -------------------- MENU -------------------- */

function toggleMenu() {
  const menu = document.getElementById("menu");
  menu.classList.toggle("hidden");
}
window.toggleMenu = toggleMenu;

function toggleSection(section, checkbox) {
  const el =
    section === "header"
      ? document.getElementById("profileHeader")
      : document.getElementById("highlightsWrap");

  if (!el) return;

  el.classList.toggle("hidden-section", !checkbox.checked);

  // close menu after toggle
  document.getElementById("menu").classList.add("hidden");
}

window.toggleSection = toggleSection;

function toggleAvatar(checkbox) {
  const profile = document.getElementById("profileHeader");
  if (!profile) return;

  profile.classList.toggle("no-avatar", !checkbox.checked);
  localStorage.setItem("showAvatar", checkbox.checked);

  document.getElementById("menu").classList.add("hidden");
}

function toggleProfileNote(checkbox) {
  const note = document.getElementById("profileNote");
  if (!note) return;

  note.classList.toggle("hidden-section", !checkbox.checked);

  // optional: remember choice
  localStorage.setItem("showProfileNote", checkbox.checked);

  // close menu
  document.getElementById("menu").classList.add("hidden");
}

function setTheme(mode) {
  if (mode === "dark") {
    document.body.setAttribute("data-theme", "dark");
  } 
  else if (mode === "light") {
    document.body.removeAttribute("data-theme");
  } 
  else {
    const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
    prefersDark
      ? document.body.setAttribute("data-theme", "dark")
      : document.body.removeAttribute("data-theme");
  }

  localStorage.setItem("theme", mode);

  // pill indicator
  const indicator = document.querySelector(".themeIndicator");
  const buttons = [...document.querySelectorAll("[data-theme-btn]")];
  const index = buttons.findIndex(b => b.dataset.themeBtn === mode);

  if (indicator && index >= 0) {
    indicator.style.transform = `translateX(${index * 100}%)`;
  }

  buttons.forEach(btn =>
    btn.classList.toggle("active", btn.dataset.themeBtn === mode)
  );

  document.getElementById("menu")?.classList.add("hidden");
}

/* -------------------- TABS -------------------- */

function moveUnderline(tab) {
  const underline = document.getElementById("slidingUnderline");
  const tabs = document.querySelector(".tabs");
  if (!underline || !tabs || !tab) return;

  const tabRect = tab.getBoundingClientRect();
  const tabsRect = tabs.getBoundingClientRect();
  const x = tabRect.left - tabsRect.left + tabRect.width / 2 - underline.offsetWidth / 2;
  underline.style.transform = `translateX(${x}px)`;
}

function setFilter(type, el) {
  FILTER = type;

  document.querySelectorAll(".tabItem").forEach(tab => {
    tab.classList.remove("active");
    const img = tab.querySelector("img");
    img.src = `/icons/${tab.dataset.type}-${tab === el ? "dark" : "light"}.png`;
  });

  el.classList.add("active");
  moveUnderline(el);
  renderGrid();
}
window.setFilter = setFilter;

/* -------------------- DATA LOAD -------------------- */

async function loadPosts(btn) {
  const icon = btn?.querySelector(".refreshIcon");
  if (icon) icon.classList.add("spin");

  if (!btn) {
    document.querySelector(".container").setAttribute("data-loading", "true");
    document.getElementById("skeleton").style.display = "block";
  }

  try {
    const slug = getSlug();
    const res = await fetch(`/api/get-posts?slug=${slug}`);
    const { profile: apiProfile, posts, plan } = await res.json();

    ALL_POSTS = Array.isArray(posts) ? posts : [];
    sessionStorage.setItem("cachedPosts", JSON.stringify(ALL_POSTS));

    const derivedProfile = extractProfileFromPosts(ALL_POSTS);
    const finalProfile = apiProfile || derivedProfile;

    document.getElementById("profileName").innerText = finalProfile.name;
    document.getElementById("profileImage").src = finalProfile.picture;

    // ✅ PROFILE NOTE (MUST be inside try)
    const noteEl = document.getElementById("profileNote");
    if (apiProfile?.note) {
      noteEl.textContent = apiProfile.note;
      noteEl.classList.remove("hidden-section");
    } else {
      noteEl.classList.add("hidden-section");
    }

    renderHighlights(ALL_POSTS);
    renderGrid();

    const stats = computeStatsFromGrid(getVisibleGridPosts());
    document.getElementById("statPosts").innerText = stats.total;
    document.getElementById("statScheduled").innerText = stats.scheduled;
    document.getElementById("statPublished").innerText = stats.published;

  } catch (e) {
    console.error("loadPosts failed:", e);
  }

  if (!btn) {
    document.getElementById("skeleton").style.display = "none";
    document.querySelector(".container").removeAttribute("data-loading");
  }

  if (icon) icon.classList.remove("spin");
}

/* -------------------- GRID -------------------- */

function renderGrid() {
  const grid = document.getElementById("grid");
  grid.innerHTML = "";

  getVisibleGridPosts().forEach(post => {
    const card = document.createElement("div");
    card.className = "card";

    const src =
      (Array.isArray(post.attachment) && post.attachment[0]) ||
      post.thumbnail ||
      post.video;

    if (src) {
      if (src.match(/\.(mp4|webm|ogg)/i)) {
        const v = document.createElement("video");
        v.src = src;
        v.muted = true;
        v.playsInline = true;
        card.appendChild(v);
      } else {
        const img = document.createElement("img");
        img.src = src;
        card.appendChild(img);
      }
    }

    if (isMultiMedia(post)) {
  addBadge(card, "/icons/multi.png");   // stacked icon
}
if (post.pinned) {
  addBadge(card, "/icons/pin.png");     // pin on top
}
    card.onclick = () => openViewer(post);
    grid.appendChild(card);
  });
}

function addBadge(card, src, index = 0) {
  const img = document.createElement("img");
  img.src = src;
  img.className = "badge";
  img.style.top = `${6 + index * 18}px`;  // stack vertically
  card.appendChild(img);
}
  function isMultiMedia(post) {
  return Array.isArray(post.attachment) && post.attachment.length > 1;
}


/* -------------------- HIGHLIGHTS -------------------- */

function renderHighlights(posts) {
  const row = document.getElementById("highlights");
  row.innerHTML = "";

  const MAX = 10;

  const items = posts.filter(
    p => p.highlight && hasMedia(p) && !p.hide
  );

  // 1️⃣ Render real highlights
  items.slice(0, MAX).forEach(post => {
    const wrap = document.createElement("div");
    wrap.className = "highlightItem";

    const img = document.createElement("img");
    img.src = post.attachment?.[0] || post.thumbnail;

    wrap.appendChild(img);
    wrap.onclick = () => openViewer(post);
    row.appendChild(wrap);
  });

  // 2️⃣ Render placeholders to fill up to MAX
  const remaining = MAX - items.length;

  for (let i = 0; i < remaining; i++) {
    const ph = document.createElement("div");
    ph.className = "highlightItem highlightPlaceholder";
    row.appendChild(ph);
  }
}
/* -------------------- VIEWER -------------------- */

function openViewer(post) {
  currentMedia =
    post.attachment?.length ? post.attachment :
    post.video ? [post.video] :
    post.thumbnail ? [post.thumbnail] : [];

  currentSlide = 0;
  updateViewerImage();

  document.getElementById("viewerTitle").innerText = post.name || "";
  document.getElementById("viewer").classList.remove("hidden");
  requestAnimationFrame(() => document.getElementById("viewer").classList.add("show"));
}

function updateViewerImage() {
  const wrap = document.getElementById("viewerMedia");
  wrap.innerHTML = "";

  const src = currentMedia[currentSlide];
  if (!src) return;

  const el = src.match(/\.(mp4|webm|ogg)/i)
    ? Object.assign(document.createElement("video"), { src, controls: true })
    : Object.assign(document.createElement("img"), { src });

  wrap.appendChild(el);

  const showNav = currentMedia.length > 1;
  document.querySelector(".nav.prev").style.display = showNav ? "flex" : "none";
  document.querySelector(".nav.next").style.display = showNav ? "flex" : "none";
}
  function nextImage() {
  if (!currentMedia.length) return;

  currentSlide = (currentSlide + 1) % currentMedia.length;
  updateViewerImage();
}

function prevImage() {
  if (!currentMedia.length) return;

  currentSlide =
    (currentSlide - 1 + currentMedia.length) % currentMedia.length;
  updateViewerImage();
}

window.nextImage = nextImage;
window.prevImage = prevImage;

async function checkAccess() {
  return true;
}

async function startGrid() {
  let slugRetries = window.__slugRetries || 0;
window.__slugRetries = slugRetries + 1;

if (!getSlug()) {
  if (slugRetries < 20) {           // ~6 seconds max
    setTimeout(startGrid, 300);
    return;
  } else {
    // ⛑️ FAILSAFE: stop skeleton
    document.getElementById("skeleton").style.display = "none";
    document.querySelector(".container").removeAttribute("data-loading");
    return;
  }
}
    
    const cached = sessionStorage.getItem("cachedPosts");
if (cached) {
  ALL_POSTS = JSON.parse(cached);

  renderHighlights(ALL_POSTS);
  renderGrid();

  document.querySelector(".container")
    .removeAttribute("data-loading");
}
    const savedTheme = localStorage.getItem("theme") || "default";
setTsheme(savedTheme);

requestAnimationFrame(() => {
  const indicator = document.querySelector(".themeIndicator");
  const buttons = [...document.querySelectorAll("[data-theme-btn]")];
  const index = buttons.findIndex(b => b.dataset.themeBtn === savedTheme);
  if (indicator && index >= 0) {
    indicator.style.transform = `translateX(${index * 100}%)`;
  }
});

document
  .querySelector(`input[name="theme"][value="${savedTheme}"]`)
  ?.setAttribute("checked", true);

const showAvatar = localStorage.getItem("showAvatar");
if (showAvatar === "false") {
  const avatarToggle = document.querySelector(
    'input[onchange="toggleAvatar(this)"]'
  );
  if (avatarToggle) {
    avatarToggle.checked = false;
    document.getElementById("profileHeader")
      .classList.add("no-avatar");
  }
}

const showNote = localStorage.getItem("showProfileNote");
if (showNote === "false") {
  document.getElementById("profileNote")?.classList.add("hidden-section");

  const noteToggle = document.querySelector(
    'input[onchange="toggleProfileNote(this)"]'
  );
  if (noteToggle) noteToggle.checked = false;
}

    await checkAccess();
    await loadPosts();

    requestAnimationFrame(() => {
      const activeTab = document.querySelector(".tabItem.active");
      if (activeTab) moveUnderline(activeTab);
    });
  } catch (e) {
    console.error("Grid init failed", e);
  }
}

function closeViewer() {
  const v = document.getElementById("viewer");
  v.classList.remove("show");
  setTimeout(() => v.classList.add("hidden"), 250);
}
window.closeViewer = closeViewer;
  document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") closeViewer();
});


/* -------------------- INIT -------------------- */

document.querySelector(".refreshBtn").onclick = function () {
  loadPosts(this);
};
  document.addEventListener("click", () => {
  const menu = document.getElementById("menu");
  if (!menu.classList.contains("hidden")) {
    menu.classList.add("hidden");
  }
});

window.addEventListener("load", startGrid);
</script>
</body>
</html>
