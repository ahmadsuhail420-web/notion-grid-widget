<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />

  <style>
    /* ---------- BASE ---------- */
    body {
      font-family: sans-serif;
      max-width: 640px;
      min-height: 640px;
      margin: auto;
      background: #ffffff;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 15px 20px 0;
      border-radius: 24px;
      border: 3px solid #e2e2e2;
    }

    .widgetWrap {
      width: 100%;
      max-width: 640px;
      height: 640px;
      background: #ffffff;
      position: relative;
      display: flex;
      flex-direction: column;
      border-radius: 24px;
    }

    .topBar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      position: relative;
    }

    /* PROFILE */
    .profile {
      padding: 16px;
      display: flex;
      justify-content: center;
    }

    .profileRow {
      display: flex;
      width: 100%;
      max-width: 520px;
      align-items: center;
      gap: 20px;
    }

    .profilePic {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      overflow: hidden;
      background: #eee;
      flex-shrink: 0;
    }

    .profilePic img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profileRight {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding: 2px 6px;
    }

    .profileTitle {
      font-size: 18px;
      font-weight: 700;
      line-height: 1.2;
    }

    .profileStats {
      display: grid;
      grid-template-columns: repeat(3, auto);
      column-gap: 28px;
      margin-top: 10px;
    }

    .stat {
      text-align: center;
    }

    .stat strong {
      font-size: 16px;
      font-weight: 700;
      display: block;
    }

    .stat span {
      font-size: 12px;
      color: #777;
    }

    /* ---------- CONTAINER ---------- */
    .container {
      flex: 1;
      min-height: 0;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      width: 100%;
    }

    .container.popup-open .gridWrap {
      opacity: 0.4;
    }

    .menuBtn {
      background: transparent;
      border: none;
      font-size: 22px;
      color: #000;
      cursor: pointer;
      padding: 4px 6px;
    }

    .menu {
      position: absolute;
      top: 44px;
      right: 12px;
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      padding: 10px 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 20;
    }

    .menu.hidden {
      display: none;
    }

    .menuItem {
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    /* ---------- HEADER ---------- */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      position: relative;
    }

    .refreshBtn {
      background: transparent;
      color: #000;
      border: none;
      padding: 6px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .refreshIcon {
      font-size: 18px;
      color: #000;
    }

    .refreshIcon.spin {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* HIGHLIGHTS */
    .highlights {
      padding: 8px 16px 0;
    }

    .highlightsRow {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      scrollbar-width: none;
    }

    .highlightsRow::-webkit-scrollbar {
      display: none;
    }

    .highlightItem {
      width: 62px;
      height: 62px;
      border-radius: 50%;
      overflow: hidden;
      flex-shrink: 0;
      border: 2px solid #ddd;
    }

    .highlightItem img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* ---------- TABS ---------- */
    .tabs {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      align-items: center;
      padding: 10px 0 8px;
      position: relative;
    }

    .tabItem {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .tabItem img {
      width: 22px;
      height: 22px;
      opacity: 0.45;
      transition: transform 0.25s ease, opacity 0.25s ease;
    }

    .tabItem.active img {
      opacity: 1;
      transform: translateY(-2px) scale(1.05);
    }

    .slidingUnderline {
      position: absolute;
      bottom: 0;
      height: 2px;
      width: 18px;
      background: black;
      border-radius: 2px;
      transform: translateX(0);
      transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ---------- GRID ---------- */
    .gridWrap {
      flex: 1;
      overflow-y: auto;
      scrollbar-width: none;
      transition: opacity 0.2s ease;
    }

    .gridWrap::-webkit-scrollbar {
      display: none;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 3px;
      padding: 4px;
    }

    .card {
      aspect-ratio: 4 / 5;
      background: #efefef;
      overflow: hidden;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card img,
    .card video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .card img {
      z-index: 1;
      pointer-events: none;
    }

    .card video {
      opacity: 0;
      transition: opacity 0.2s ease;
      pointer-events: none;
    }

    .card:hover video {
      opacity: 1;
    }

    .card .badge {
      position: absolute;
      top: 4%;
      right: 6%;
      width: 16%;
      height: 16%;
      object-fit: contain;
      z-index: 5;
      opacity: 0.8;
      pointer-events: none;
    }

    /* ---------- VIEWER ---------- */
    .viewer {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
    }

    .viewer.show {
      opacity: 1;
      pointer-events: auto;
    }

    .viewer.hidden {
      display: none;
    }

    .viewerInner {
      width: min(360px, 85%);
      position: relative;
      transform: scale(0.96);
      transition: transform 0.25s ease;
    }

    .viewer.show .viewerInner {
      transform: scale(1);
    }

    .viewerCard {
      background: #fff;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 12px 40px rgba(0,0,0,0.25);
    }

    .viewerImage {
      aspect-ratio: 4 / 5;
      overflow: hidden;
    }

    .viewerImage img,
    .viewerImage video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .viewerFooter {
      padding: 14px 16px;
      border-top: 1px solid #eee;
    }

    .viewerClose,
    .nav {
      position: absolute;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(0,0,0,0.65);
      color: #fff;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.35);
    }

    .viewerClose {
      top: -14px;
      right: -14px;
      font-size: 16px;
    }

    .nav {
      top: 50%;
      transform: translateY(-50%);
      font-size: 20px;
    }

    .nav.prev { left: -14px; }
    .nav.next { right: -14px; }

    .footer {
      text-align: center;
      padding: 8px 0;
      font-size: 13px;
      color: #777;
    }
  </style>
</head>
<body>
  <div class="widgetWrap">
    <div class="container">

      <div class="header">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <button class="refreshBtn">
          <span class="material-icons refreshIcon">refresh</span>
        </button>

        <button class="menuBtn" onclick="toggleMenu()">⋯</button>

        <div id="menu" class="menu hidden">
          <label class="menuItem">
            <input type="checkbox" checked onchange="toggleSection('header', this)">
            Show header
          </label>
          <label class="menuItem">
            <input type="checkbox" checked onchange="toggleSection('highlights', this)">
            Show highlights
          </label>
        </div>
      </div>

      <div id="profileHeader" class="profile">
        <div class="profileRow">
          <div class="profilePic">
            <img id="profileImage" src="/icons/profile-placeholder.png" />
          </div>

          <div class="profileRight">
            <div id="profileName" class="profileTitle">Grid Planner</div>

            <div class="profileStats">
              <div class="stat">
                <strong id="statPosts">0</strong>
                <span>Posts</span>
              </div>
              <div class="stat">
                <strong id="statScheduled">0</strong>
                <span>Scheduled</span>
              </div>
              <div class="stat">
                <strong id="statPublished">0</strong>
                <span>Published</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- HIGHLIGHTS -->
      <div id="highlightsWrap" class="highlights">
        <div id="highlights" class="highlightsRow"></div>
      </div>

      <!-- TABS -->
      <div class="contentArea">
        <div class="tabs">
          <div class="tabItem active" data-type="post" onclick="setFilter('Post', this)">
            <img src="/icons/post-dark.png">
          </div>

          <div class="tabItem" data-type="reel" onclick="setFilter('Reels', this)">
            <img src="/icons/reel-light.png">
          </div>

          <div class="tabItem" data-type="story" onclick="setFilter('Story', this)">
            <img src="/icons/story-light.png">
          </div>

          <div class="tabItem" data-type="tiktok" onclick="setFilter('Tiktok', this)">
            <img src="/icons/tiktok-light.png">
          </div>

          <div class="slidingUnderline" id="slidingUnderline"></div>
        </div>

        <div class="gridWrap">
          <div id="grid" class="grid"></div>
        </div>
      </div>

      <!-- MEDIA VIEWER -->
      <div id="viewer" class="viewer hidden">
        <div class="viewerInner">
          <button class="viewerClose" onclick="closeViewer()">✕</button>
          <button class="nav prev" onclick="prevImage()">‹</button>
          <button class="nav next" onclick="nextImage()">›</button>

          <div class="viewerCard">
            <div class="viewerImage" id="viewerMedia"></div>

            <div class="viewerFooter">
              <div id="viewerTitle"></div>
              <div id="viewerDate"></div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <div class="footer">Alif Designs</div>
  </div>

<script>
const params = new URLSearchParams(window.location.search);
const SLUG = params.get("slug");
if (!SLUG) alert("Missing widget slug");

let ALL_POSTS = [];
let FILTER = "Post";

let currentSlide = 0;
let currentMedia = [];

/* -------------------- HELPERS -------------------- */

function computeStats(posts) {
  const today = new Date().toISOString().split("T")[0];
  const visible = posts.filter(p => !p.hide);

  const scheduled = visible.filter(p => p.publishDate && p.publishDate > today);
  const published = visible.filter(p => p.publishDate && p.publishDate <= today);

  return {
    total: visible.length,
    scheduled: scheduled.length,
    published: published.length
  };
}

function extractProfileFromPosts(posts) {
  const rowWithName = posts.find(p => p.profileName);
  const rowWithPic = posts.find(p => p.profilePicture);

  return {
    name: rowWithName?.profileName || "Grid Planner",
    picture: rowWithPic?.profilePicture || null
  };
}

function getHighlights(posts) {
  return posts.filter(p =>
    p.highlight &&
    !p.hide &&
    ((Array.isArray(p.attachment) && p.attachment.length) || p.thumbnail)
  );
}

function getNotionThumbnail(post) {
  if (!post?.thumbnail) return null;
  if (typeof post.thumbnail === "string") return post.thumbnail;
  return null;
}

/* -------------------- MENU -------------------- */

function toggleMenu() {
  document.getElementById("menu").classList.toggle("hidden");
}
window.toggleMenu = toggleMenu;

function toggleSection(section, checkbox) {
  if (section === "header") {
    document.getElementById("profileHeader").style.display =
      checkbox.checked ? "block" : "none";
  }

  if (section === "highlights") {
    document.getElementById("highlightsWrap").style.display =
      checkbox.checked ? "block" : "none";
  }
}
window.toggleSection = toggleSection;

/* -------------------- TABS -------------------- */

function moveUnderline(tab) {
  const underline = document.getElementById("slidingUnderline");
  const tabs = document.querySelector(".tabs");
  if (!underline || !tabs || !tab) return;

  const tabRect = tab.getBoundingClientRect();
  const tabsRect = tabs.getBoundingClientRect();

  const x =
    tabRect.left - tabsRect.left +
    tabRect.width / 2 - underline.offsetWidth / 2;

  underline.style.transform = `translateX(${x}px)`;
}

function setFilter(type, el) {
  FILTER = type;

  document.querySelectorAll(".tabItem").forEach(tab => tab.classList.remove("active"));
  el.classList.add("active");

  document.querySelectorAll(".tabItem").forEach(tab => {
    const img = tab.querySelector("img");
    const iconType = tab.dataset.type;
    img.src = tab.classList.contains("active")
      ? `/icons/${iconType}-dark.png`
      : `/icons/${iconType}-light.png`;
  });

  moveUnderline(el);
  renderGrid();
}
window.setFilter = setFilter;

/* -------------------- ACCESS -------------------- */

async function checkAccess() {
  const res = await fetch(`/api/check-access?slug=${SLUG}`);
  const data = await res.json();

  if (!data.active) {
    document.body.innerHTML = `
      <div style="text-align:center;padding:40px;font-family:sans-serif;">
        <h3>Access inactive</h3>
        <p>Your subscription is not active.</p>
      </div>
    `;
    throw new Error("Access inactive");
  }
}

/* -------------------- FETCH -------------------- */

async function loadPosts(btn) {
  const icon = btn?.querySelector(".refreshIcon");
  if (icon) icon.classList.add("spin");

  try {
    const res = await fetch(`/api/get-posts?slug=${SLUG}`);
    const { profile: apiProfile, posts } = await res.json();

    ALL_POSTS = Array.isArray(posts) ? posts : [];

    const derivedProfile = extractProfileFromPosts(ALL_POSTS);
    const finalProfile = apiProfile || derivedProfile;

    // PROFILE UI
    document.getElementById("profileName").innerText =
      finalProfile?.name || "Grid Planner";

    document.getElementById("profileImage").src =
      finalProfile?.picture || "/icons/profile-placeholder.png";

    // STATS UI
    const stats = computeStats(ALL_POSTS);
    document.getElementById("statPosts").innerText = stats.total;
    document.getElementById("statScheduled").innerText = stats.scheduled;
    document.getElementById("statPublished").innerText = stats.published;

    // HIGHLIGHTS UI
    renderHighlights(ALL_POSTS);

    // GRID UI
    renderGrid();

    // UNDERLINE FIX (after layout)
    requestAnimationFrame(() => {
      const activeTab = document.querySelector(".tabItem.active");
      if (activeTab) moveUnderline(activeTab);
    });

  } catch (e) {
    console.error("loadPosts failed:", e);
  }

  if (icon) icon.classList.remove("spin");
}

/* -------------------- GRID -------------------- */

function renderGrid() {
  const grid = document.getElementById("grid");
  if (!grid) return;

  grid.innerHTML = "";

  const filtered = ALL_POSTS.filter(post => {
    if (post.hide) return false;
    if (!Array.isArray(post.type) || post.type.length === 0) return true;
    return post.type.includes(FILTER);
  });

  filtered.forEach(post => {
    const card = document.createElement("div");
    card.className = "card";

    if (Array.isArray(post.attachment) && post.attachment.length > 0) {
      const img = document.createElement("img");
      img.src = post.attachment[0];
      card.appendChild(img);

    } else if (post.thumbnail) {
      const img = document.createElement("img");
      img.src = post.thumbnail;
      card.appendChild(img);

    } else if (post.video) {
      const thumb = getNotionThumbnail(post);
      if (thumb) {
        const img = document.createElement("img");
        img.src = thumb;
        card.appendChild(img);
      }
    }

    const hasVideo = !!post.video;
    const isMulti = Array.isArray(post.attachment) && post.attachment.length > 1;

    if (post.pinned) addBadge(card, "/icons/pin.png");
    else if (hasVideo) addBadge(card, "/icons/reel-badge.png");
    else if (isMulti) addBadge(card, "/icons/multi.png");

    card.addEventListener("click", () => openViewer(post));
    grid.appendChild(card);
  });
}

function addBadge(card, src) {
  const img = document.createElement("img");
  img.src = src;
  img.className = "badge";
  card.appendChild(img);
}

/* -------------------- HIGHLIGHTS -------------------- */

function renderHighlights(posts) {
  const wrap = document.getElementById("highlightsWrap");
  const row = document.getElementById("highlights");
  if (!wrap || !row) return;

  row.innerHTML = "";
  wrap.style.display = "block";

  const items = getHighlights(posts);

  if (!items.length) {
    const add = document.createElement("div");
    add.className = "highlightItem";
    add.style.display = "flex";
    add.style.alignItems = "center";
    add.style.justifyContent = "center";
    add.style.fontSize = "26px";
    add.innerText = "+";
    row.appendChild(add);
    return;
  }

  items.forEach(post => {
    const media =
      (Array.isArray(post.attachment) ? post.attachment[0] : post.attachment) ||
      post.thumbnail;

    if (!media) return;

    const item = document.createElement("div");
    item.className = "highlightItem";

    const img = document.createElement("img");
    img.src = media;

    item.appendChild(img);
    item.onclick = () => openViewer(post);
    row.appendChild(item);
  });
}

/* -------------------- VIEWER -------------------- */

function openViewer(post) {
  currentSlide = 0;
  currentMedia = [];

  if (post.attachment) {
    currentMedia = Array.isArray(post.attachment) ? post.attachment : [post.attachment];
  } else if (post.video) {
    currentMedia = [post.video];
  } else if (post.thumbnail) {
    currentMedia = [post.thumbnail];
  }

  updateViewerImage();
  toggleNav();

  document.getElementById("viewerTitle").textContent = post.name || "";
  document.getElementById("viewerDate").textContent = formatDateShort(post.publishDate);

  document.querySelector(".container").classList.add("popup-open");
  const viewer = document.getElementById("viewer");
  viewer.classList.remove("hidden");
  requestAnimationFrame(() => viewer.classList.add("show"));
}
window.openViewer = openViewer;

function updateViewerImage() {
  const wrapper = document.getElementById("viewerMedia");
  wrapper.innerHTML = "";
  if (!currentMedia.length) return;

  const src = currentMedia[currentSlide];
  if (!src) return;

  if (src.match(/\.(mp4|webm|ogg)(\?.*)?$/i)) {
    const video = document.createElement("video");
    video.src = src;
    video.controls = true;
    video.autoplay = true;
    video.playsInline = true;
    video.style.width = "100%";
    video.style.height = "100%";
    video.style.objectFit = "cover";
    wrapper.appendChild(video);
  } else {
    const img = document.createElement("img");
    img.src = src;
    wrapper.appendChild(img);
  }
}

function toggleNav() {
  const show = currentMedia.length > 1;
  document.querySelector(".nav.prev").style.display = show ? "flex" : "none";
  document.querySelector(".nav.next").style.display = show ? "flex" : "none";
}

function closeViewer() {
  const viewer = document.getElementById("viewer");
  viewer.classList.remove("show");
  document.querySelector(".container").classList.remove("popup-open");
  setTimeout(() => viewer.classList.add("hidden"), 250);
}
window.closeViewer = closeViewer;

function prevImage() {
  currentSlide = (currentSlide - 1 + currentMedia.length) % currentMedia.length;
  updateViewerImage();
}
window.prevImage = prevImage;

function nextImage() {
  currentSlide = (currentSlide + 1) % currentMedia.length;
  updateViewerImage();
}
window.nextImage = nextImage;

/* -------------------- UTIL -------------------- */

function formatDateShort(dateStr) {
  if (!dateStr) return "";
  const date = new Date(dateStr);
  if (isNaN(date)) return "";
  return date.toLocaleDateString("en-GB", { day: "numeric", month: "short", year: "2-digit" });
}

/* -------------------- INIT -------------------- */

document.querySelector(".refreshBtn").addEventListener("click", function () {
  loadPosts(this);
});

document.getElementById("viewer").addEventListener("click", e => {
  if (e.target.id === "viewer") closeViewer();
});

document.querySelector(".viewerInner").addEventListener("click", e => e.stopPropagation());

async function startGrid() {
  try {
    await checkAccess();

    requestAnimationFrame(() => {
      const activeTab = document.querySelector(".tabItem.active");
      if (activeTab) moveUnderline(activeTab);
    });

    await loadPosts();
  } catch (e) {
    console.error("Grid init failed", e);
  }
}

window.addEventListener("load", startGrid);
</script>
</body>
</html>