<body>

<h2>Setup your Grid Widget</h2>

<div id="content" style="display:none;">
  <label>
    Workspace name:
    <input id="name" placeholder="My Content Planner" />
  </label>

  <br><br>

  <button id="connect">Connect Notion</button>
</div>

<p id="status">Verifying setup link...</p>

<script>
  function slugify(text) {
    return text
      .toLowerCase()
      .trim()
      .replace(/[^a-z0-9]+/g, "-");
  }

  const params = new URLSearchParams(window.location.search);
  const token = params.get("token");

  const content = document.getElementById("content");
  const status = document.getElementById("status");
  const connectBtn = document.getElementById("connect");

  if (!token) {
    status.innerText = "Invalid setup link";
    throw new Error("No token");
  }

  // Verify token FIRST
  fetch(`/api/verify-token?token=${token}`)
    .then(res => res.json())
    .then(data => {
      if (!data.valid) {
        status.innerText = "Setup link expired or invalid";
        return;
      }

      // Token valid â†’ show page
      status.style.display = "none";
      content.style.display = "block";
    })
    .catch(() => {
      status.innerText = "Error verifying setup link";
    });

  connectBtn.onclick = () => {
    const name = document.getElementById("name").value;

    if (!name) {
      alert("Please enter a name");
      return;
    }

    const slug = slugify(name);

    window.location.href = `/api/auth?token=${token}&slug=${slug}`;
  };
</script>

</body>