<!DOCTYPE html>
<html>
<body>
  <h2>Select your Notion database</h2>
  <ul id="dbs"></ul>

  <script>
    const slug = new URLSearchParams(location.search).get("slug");

    if (!slug) {
      document.body.innerHTML = "Missing slug";
    }

    fetch(`/api/list-databases?slug=${slug}`)
      .then(res => res.json())
      .then(dbs => {
        const ul = document.getElementById("dbs");

        dbs.forEach(db => {
          const li = document.createElement("li");
          li.innerHTML = `
            ${db.title}
            <button onclick="selectDB('${db.id}')">Select</button>
          `;
          ul.appendChild(li);
        });
      });

    function selectDB(dbId) {
      fetch("/api/save-database", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ slug, dbId })
      }).then(() => {
        location.href = `/setup-success.html?slug=${slug}`;
      });
    }
  </script>
</body>
</html>