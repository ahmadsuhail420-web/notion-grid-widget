<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Setup Grid Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Shared classic styles -->
  <link rel="stylesheet" href="/styles.css">
</head>

<body>

  <div class="page">

    <h1>Set up your Grid Planner</h1>
    <p>
      Connect your Notion workspace to generate your personal grid widget.
    </p>

    <p id="status">Verifying setup link...</p>

    <div id="content" style="display:none;">

      <label>
        Workspace name
        <input id="name" placeholder="My Content Planner" />
      </label>

      <div class="helper">
        This name is only for your reference.
      </div>

      <br><br>

      <button id="connect">
        Connect Notion
      </button>

    </div>

  </div>

  <div class="footer">
    Alif Designs
  </div>

  <script>
    function slugify(text) {
      return text
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9]+/g, "-");
    }

    const params = new URLSearchParams(window.location.search);
    const token = params.get("token");

    const content = document.getElementById("content");
    const status = document.getElementById("status");
    const connectBtn = document.getElementById("connect");

    if (!token) {
      status.innerHTML = `
        <div class="alert">
          <strong>Invalid setup link</strong><br>
          This setup link is missing or incorrect.
        </div>
      `;
      throw new Error("No token");
    }

    // Verify token
    fetch(`/api/verify-token?token=${token}`)
      .then(res => res.json())
      .then(data => {
        if (!data.valid) {
          if (data.reason === "used") {
            status.innerHTML = `
              <div class="alert">
                <strong>Setup already completed</strong><br>
                This setup link has already been used.<br>
                If you need help, please contact support.
              </div>
            `;
          } else {
            status.innerHTML = `
              <div class="alert">
                <strong>Setup link unavailable</strong><br>
This setup link has already been used or is no longer valid.
If you need help, please contact support.
              </div>
            `;
          }
          return;
        }

        // Token valid
        status.style.display = "none";
        content.style.display = "block";
      })
      .catch(() => {
        status.innerHTML = `
          <div class="alert">
            <strong>Error verifying link</strong><br>
            Please refresh the page or try again later.
          </div>
        `;
      });

    connectBtn.onclick = () => {
      const name = document.getElementById("name").value;

      if (!name) {
        alert("Please enter a workspace name");
        return;
      }

      const slug = slugify(name);
      const authUrl = `/api/auth?token=${token}&slug=${slug}`;

      window.location.href = authUrl;
    };
  </script>

</body>
</html>
